name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CMAKE_BUILD_TYPE: Release
  CTEST_OUTPUT_ON_FAILURE: 1

jobs:
  # =============================================================================
  # LINUX BUILDS
  # =============================================================================
  linux:
    name: Linux GCC ${{ matrix.version }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC builds (full C++23 support including std::expected)
          - version: 13
            cc: gcc-13
            cxx: g++-13
          - version: 14
            cc: gcc-14
            cxx: g++-14

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-${{ matrix.version }}

      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          cmake -B build \
            -DBLAZECSV_BUILD_TESTS=ON \
            -DBLAZECSV_BUILD_EXAMPLES=ON \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}

      - name: Build
        run: cmake --build build -j $(nproc)

      - name: Run Tests
        run: ctest --test-dir build --output-on-failure -j $(nproc)

      - name: Run Examples
        run: |
          ./build/examples/basic
          ./build/examples/trading_data
          ./build/examples/error_handling

  # =============================================================================
  # MACOS BUILDS
  # =============================================================================
  macos:
    name: macOS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Apple Silicon (M1/M2)
          - os: macos-14
            arch: arm64
          # Intel (macos-15 with Intel runner)
          - os: macos-15
            arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure CMake
        run: |
          cmake -B build \
            -DBLAZECSV_BUILD_TESTS=ON \
            -DBLAZECSV_BUILD_EXAMPLES=ON \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}

      - name: Build
        run: cmake --build build -j $(sysctl -n hw.ncpu)

      - name: Run Tests
        run: ctest --test-dir build --output-on-failure

      - name: Run Examples
        run: |
          ./build/examples/basic
          ./build/examples/trading_data
          ./build/examples/error_handling

  # =============================================================================
  # WINDOWS BUILDS
  # =============================================================================
  windows:
    name: Windows MSVC ${{ matrix.version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2022
            version: 2022
            generator: "Visual Studio 17 2022"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure CMake
        run: |
          cmake -B build -G "${{ matrix.generator }}" `
            -DBLAZECSV_BUILD_TESTS=ON `
            -DBLAZECSV_BUILD_EXAMPLES=ON

      - name: Build
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }}

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.CMAKE_BUILD_TYPE }} --output-on-failure

      - name: Run Examples
        run: |
          .\build\examples\${{ env.CMAKE_BUILD_TYPE }}\basic.exe
          .\build\examples\${{ env.CMAKE_BUILD_TYPE }}\trading_data.exe
          .\build\examples\${{ env.CMAKE_BUILD_TYPE }}\error_handling.exe

  # =============================================================================
  # BENCHMARKS
  # =============================================================================
  benchmark:
    name: Benchmark
    runs-on: ubuntu-24.04
    needs: linux

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install GCC 14
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14

      - name: Configure with Benchmarks
        env:
          CC: gcc-14
          CXX: g++-14
        run: |
          cmake -B build \
            -DBLAZECSV_BUILD_BENCHMARKS=ON \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build Benchmarks
        run: cmake --build build --target blazecsv_bench --config Release -j $(nproc)

      - name: Run BlazeCSV Benchmark
        run: ./build/benchmark/blazecsv_bench

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: |
            ./build/benchmark/blazecsv_bench
          retention-days: 30

  # =============================================================================
  # HEADER-ONLY VERIFICATION
  # =============================================================================
  single-header:
    name: Single Header Verification
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install GCC 14
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14

      - name: Verify Header Compiles Standalone
        run: |
          # Create minimal test that only includes the header
          cat > /tmp/test_standalone.cpp << 'EOF'
          #include "blazecsv.hpp"
          int main() {
              // Just verify it compiles
              return 0;
          }
          EOF
          g++-14 -std=c++23 -I include/blazecsv -c /tmp/test_standalone.cpp -o /tmp/test_standalone.o
          echo "Header compiles standalone: OK"

      - name: Verify No External Dependencies
        run: |
          # Check that header only uses standard library
          if grep -r "#include <" include/blazecsv/blazecsv.hpp | grep -v "std" | grep -v "chrono" | grep -v "expected" | grep -v "string" | grep -v "vector" | grep -v "array" | grep -v "charconv" | grep -v "cstring" | grep -v "sys/mman" | grep -v "sys/stat" | grep -v "fcntl" | grep -v "unistd" | grep -v "windows" | grep -v "thread" | grep -v "atomic" | grep -v "optional" | grep -v "algorithm" | grep -v "arm_neon" | grep -v "emmintrin" | grep -v "intrin"; then
            echo "WARNING: Found non-standard includes"
          else
            echo "No unexpected external dependencies: OK"
          fi

  # =============================================================================
  # INSTALL TEST
  # =============================================================================
  install:
    name: Install & Find Package
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install GCC 14
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-14

      - name: Configure
        env:
          CC: gcc-14
          CXX: g++-14
        run: cmake -B build -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install

      - name: Build
        run: cmake --build build

      - name: Install
        run: cmake --install build

      - name: Test find_package
        env:
          CC: gcc-14
          CXX: g++-14
        run: |
          mkdir -p /tmp/test_project
          cat > /tmp/test_project/CMakeLists.txt << 'EOF'
          cmake_minimum_required(VERSION 3.14)
          project(test_find_package)
          find_package(blazecsv REQUIRED)
          add_executable(test_app main.cpp)
          target_link_libraries(test_app PRIVATE blazecsv::blazecsv)
          EOF

          cat > /tmp/test_project/main.cpp << 'EOF'
          #include <blazecsv/blazecsv.hpp>
          int main() { return 0; }
          EOF

          cmake -B /tmp/test_project/build -S /tmp/test_project \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install
          cmake --build /tmp/test_project/build
          echo "find_package test: OK"

  # =============================================================================
  # SUMMARY
  # =============================================================================
  ci-success:
    name: CI Success
    needs: [linux, macos, windows, single-header, install]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.linux.result }}" != "success" ]] || \
             [[ "${{ needs.macos.result }}" != "success" ]] || \
             [[ "${{ needs.windows.result }}" != "success" ]] || \
             [[ "${{ needs.single-header.result }}" != "success" ]] || \
             [[ "${{ needs.install.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed!"
